# Quality {#quality .tabset .tabset-fade .tabset-pills}

A record is considered _completed_ when it has at least the sheets 
**anagrafica**, **accettazione**, **pim**, **dimissione** marked as completed.

---



## Complete records {.tabset .tabset-dropdown}

```{r}
qualityReportUI("q_overall")
```

```{r, context = "server"}
qualityReport("q_overall", data = full_records)
```




## Hospitalized {.tabset .tabset-dropdown}

Records are considered related to an "hospitalized" patient if the field 
**reparto** is not missing in the sheet **dimissione**.

```{r}
qualityReportUI("q_hosp")
```

```{r, context = "server"}
data_hosp <- filter(full_records, !is.na(reparto))
qualityReport("q_hosp", data = data_hosp)
```




## Data errors {.tabset .tabset-dropdown}

Two types of errors are considerend at the moment:

1. missing data
2. outlier values out of reasonable range, i.e., which have a distance from the
   median that is farther than 1.5 times the inter quartile range.


### Missing values


```{r}
n_missing <- map_int(full_records, ~sum(is.na(.)))
are_w_missing <- n_missing > 0
```

Overall, there are `r sum(are_w_missing)` variables with some missing data (out of `r length(full_records)`) for a total number of `r sum(n_missing)` missing entries in the whole dataset (`r round(100 * mean(is.na(full_records)), 2)`% of missingness).

```{r}
data_miss <- full_records %>%
  group_by(center) %>%
  summarise_all(~sum(is.na(.))) %>%
  pivot_longer(-center, names_to = "field")

n_each <- full_records %>%
  group_by(center) %>%
  tally()

data_miss <- data_miss %>%
  left_join(n_each) %>%
  mutate(prop = round(value / n, 2))
```

```{r}
gg_miss_all <- tibble(TIPNet = n_missing) %>% 
    ggplot(aes(y = TIPNet)) +
      geom_boxplot() +
      ylab(glue(
        "N missing (out of N = {nrow(full_records)})"
      )) +
      ggtitle('Distribution of overall missingness')


ggplotly(gg_miss_all)

```

```{r}
gg_miss_each <- data_miss %>%
    dplyr::mutate(
      center = fct_reorder(center, prop, .fun = "median")
    ) %>% 
    ggplot(aes(x = center, y = prop, colour = center)) +
      geom_boxplot() +
      theme(
        legend.position = "none",
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)
      ) + 
      ylab("Proportions") +
      xlab("") +
      coord_flip() +
      ggtitle('Distributions of missigness by center')

ggplotly(gg_miss_each)
```


```{r}
datatable(data_miss, filter = list(position = 'top', clear = TRUE))
```




### Possible errors into the data


For numerical variables, outliers are considered possible errors, i.e. values
farther than 1.5 times the inter quartile range from the median.



```{r}
outliers <- full_records %>% 
  group_by(center, codpat, redcap_repeat_instance) %>% 
  select_if(is.numeric) %>%
  ungroup() %>% 
  mutate_at(vars(-center, -codpat, -redcap_repeat_instance),
    ~ abs(. - median(., na.rm = TRUE)) > 
      1.5 * diff(quantile(., probs = c(0.25, 0.75), na.rm = TRUE))
  ) %>% 
  janitor::remove_empty("cols") %>%
  group_by(center, codpat, redcap_repeat_instance) %>% 
  select_if(~any(. == TRUE, na.rm = TRUE)) %>% 
  ungroup() %>% 
  pivot_longer(-c(center, codpat, redcap_repeat_instance)) %>% 
  group_by(center) %>% 
  mutate(n = n()) %>% 
  filter(value) %>% 
  summarize(
    n_outliers = n(),
    prop_outliers = round(n_outliers / unique(n), 2),
    codpats = list(tibble(
      codpat = codpat,
      var = name,
      rep_instance = redcap_repeat_instance,
      value = pmap_dbl(
        list(x = codpat, y = var, z = rep_instance, c = center),
        function(x, y, z, c) {
          res <- full_records %>% 
            filter(codpat == x, redcap_repeat_instance == z, center == c)
          res[[y]]
        }
      )
    ))
  )

outliers[["codpats"]][[3]]
```
