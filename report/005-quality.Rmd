# Quality {#quality .tabset .tabset-fade .tabset-pills}

A record is considered _completed_ when it has at least the sheets 
**anagrafica**, **accettazione**, **pim**, **dimissione** marked as completed.

---

## Complete records {.tabset .tabset-dropdown}

```{r, eval=!params$export}
qualityReportUI("q_overall")
```

```{r, context = "server", eval=!params$export}
qualityReport("q_overall", data = full_records)
```

```{r, context = "server", eval=params$export, fig.height=11}
qualityReportStatic(full_records,
  params$q_overall_completed,
  params$q_overall_type
)
```








## Hospitalized {.tabset .tabset-dropdown}

Records are considered related to an "hospitalized" patient if the field 
**reparto** is not missing in the sheet **dimissione**.

```{r, eval=!params$export}
qualityReportUI("q_hosp")
```

```{r, context = "server", eval=!params$export}
data_hosp <- dplyr::filter(full_records, !is.na(reparto))
qualityReport("q_hosp", data = data_hosp)
```

```{r, context = "server", eval=params$export, fig.height=11}
data_hosp <- dplyr::filter(full_records, !is.na(reparto))
qualityReportStatic(data_hosp,
  params$q_hosp_completed,
  params$q_hosp_type
)
```








## Data errors {.tabset .tabset-dropdown}

Two types of errors are considered at the moment:

1. Missing data.

2. Outlier values out of reasonable range, i.e., which have a distance
   from the median that is farther than 1.5 times the inter quartile
   range.


### Missing values


```{r}
n_missing <- map_int(full_records, ~sum(is.na(.)))
prop_missing <- map_dbl(full_records, ~mean(is.na(.)))
are_w_missing <- n_missing > 0
```

Overall, there are `r sum(are_w_missing)` variables with some missing
data (out of `r length(full_records)`) for a total number of `r
sum(n_missing)` missing entries in the whole dataset (`r round(100 *
mean(is.na(full_records)), 2)`% of missingness).

```{r, eval=!params$export}
data_miss <- full_records %>%
  dplyr::group_by(center) %>%
  dplyr::summarise_all(~mean(is.na(.))) %>%
  tidyr::pivot_longer(-center, names_to = "field", values_to = "prop")
```

```{r, eval=!params$export, fig.height=9}
data_miss %>%
  ggplot(aes(x = center, y = prop, colour = center)) +
    geom_boxplot(outlier.shape = NA) +
    geom_boxplot(outlier.shape = NA,
      data = tibble(TIPmiss = prop_missing),
      aes(x = "TIPNet", y = TIPmiss), colour = "black"
    ) +
    theme_minimal() +
    theme(
      legend.position = "none",
      axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)
    ) + 
    ylab("Proportions") +
    xlab("") +
    coord_flip(ylim = c(0.5, 1)) +
    ggtitle('Distributions of missigness by center')
```


```{r, eval=!params$export}
data_miss %>% 
  transmute(center,
    field = as.factor(field),
    `missing (%)` = 100 * round(prop, 4)
  ) %>% 
  datatable(filter = list(position = 'top', clear = TRUE))
```




### Possible errors into the data


For numerical variables, outliers are considered possible errors, i.e.
values farther than 1.5 times the inter quartile range from the median.

```{r, eval=!params$export}
outlierReportUI("q_err", data = outliers)
```

```{r, context = "server", eval=!params$export}
outlierReport("q_err", data = outliers)
```
