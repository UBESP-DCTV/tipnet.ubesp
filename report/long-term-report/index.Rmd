--- 
params:
    export: FALSE
    period: "2010 -- 2014"
    picu_type: ["M/S", "C/N", "n/p"]
    breaks: 20L

output:
    bookdown::html_document2:
        toc: true
        toc_float: true
        toc_depth: 2
        df_print: paged

runtime: shiny_prerendered

title: "`r paste0('TIPNet long-term report, years ', params$period)`"
subtitle: "(prototype by Corrado Lanera^[Unità di Biostatistica, Epidemiologia, e Sanlute Pubblica --- Dipartimento di Scienze Cardio-Toraco-Vascolari e Salute Pubblica (Università di Padova -- IT)])"
author: "Italian Pediatric Intensive Care Units Network (TIPNet) in collaboration with Italian Society of Pediatric and Neonatal Anesthesia and Intensive Care (SARNePI) and CINECA"
date: "**Last update**: `r Sys.Date()`"

biblio-style: apalike
link-citations: yes
bibliography:
  - bibliography.bib
  - packages.bib

description: "`r paste0('Prototype example for the TIPNet long-term report (years ', params$period, ')')`"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)

suppressPackageStartupMessages(library(tidyverse, quietly = TRUE))
suppressPackageStartupMessages(library(glue, quietly = TRUE))
# suppressPackageStartupMessages(library(tipnet.ubesp, quietly = TRUE))

gg_picu_type <- function(param) {
  filter(foo, type %in% param) %>% 
    ggplot(aes(x = year, y = beds, colour = unit)) +
    geom_line()
}
```

```{r data, include=FALSE, cache=TRUE, cache.extra=file.info("bar.csv")$mtime}
# this would only simulate a cache for imprted dataset, which is 
# re-imported only if the modified time changed!!
write_lines("a, b, c\n1, 2, 3", "bar.csv")
bar <- read_csv("bar.csv")

foo <- tibble(
    unit = letters,
    type = c("M/S", "C/N", "n/p")[sample.int(3, 26, replace = TRUE)]
  ) %>% 
  full_join(tibble(
    unit = rep(letters, 5),
    year = rep(2010:2014, 26),
    beds = sample(c(NA, 0:10), 130, replace = TRUE)
  ))
```


# Colophon {-}

**Network coordinator**: Andrea Wolfler, MD ([Department of Anesthesia and Intensive Care Unit](https://www.asst-fbf-sacco.it/reparti-e-servizi/info/anestesia-e-rianimazione-pediatrica) -- [Children’s Hospital Vittore Buzzi](https://www.asst-fbf-sacco.it/reparti-e-servizi/ricerca-reparto-presidio/buzzi)) --- Milan

**In collaboration with**: [Unit of Biostatistics, Epidemiology and Public Helath](https://ubesp.jimdo.com/) ([Department Cardiac, Toracic, Vascular sciences and Public Health](https://www.dctv.unipd.it/) -- [University of Padova](https://www.unipd.it/)) --- Interuniversity Consortium


**Business intelligence analyst**: Roberta Amato

**IT Project Managers**: Chiara Dellacasa, Giulia Stabile

**With the contribution of**:

- F. Racca, J Gualino - Alessandria
- F. Ferrero, R Osello, R Gilodi - Novara
- I Salvo, E. Zoia, A. Mandelli - Milano
- E Calderini, C. Montani, E. Prandi - Milano
- P. Biban, P Santuz - Verona
- A. Pettenazzo, A Amigoni - Padova
- S. Furlan, F Savron - Trieste
- F Caramelli, C. Mondardini, E. Iannella - Bologna
- C Cecchetti, D Perrotta - Roma
- S Picardo, E Rossetti - Roma
- M Corbari - Roma
- G. Conti, M Piastra, O. Genovese - Roma
- R Testa, A Dolcini, L. D’Amato - Napoli
- G Coffaro, A. M. Guddo, A. M. Giglio - Palermo
- E Gitto - Messina
- G Stancanelli - Catania

**TIPNet study group** - participating center:

- Department of Anesthesia and Intensive Care, Children’s Hospital Sant’Antonio e Biagio e Cesare Arrigo, Alessandria:
- Department of Pediatrics, Ospedale Maggiore della Carità, Novara:
- Department of Anesthesia and Intensive Care, Children’s Hospital V Buzzi, Milan:
- Department of Anesthesia and Intensive Care, Fondazione IRCCS Ca Granda, Ospedale Maggiore Policlinico, Milan:
- Department of Pediatric Anesthesia and Intensive Care, Spedali Civili, Brescia
- Department of Neonatal and Paediatric Intensive Care, Azienda Ospedaliera Universitaria Integrata, Verona
- Department of Woman’s and Child’s Health, Pediatric ICU, University Hospital, Padova
- Department of Anesthesia and Intensive Care, Institute for Maternal and Child health, IRCCS Burlo Garofolo, Trieste
- Department of Pediatric Anesthesia and Intensive Care, Ospedale Sant’Orsola Malpighi, Bologna
- Department of Anesthesia and Intensive Care, Children’s Hospital Meyer, Firenze
- Department of Anesthesia and Intensive Care, Children’s Hospital Bambino Gesù, Rome DEA, ARCO, Palidoro
- Anesthesia and Intensive Care Department, Pediatric ICU, Policlinico Universitario A.Gemelli, Università Cattolica
del Sacro Cuore, Rome
- Department of Anesthesia and Intensive Care, Children’s Hospital Santobono-Pausillipon, Napoli
- Department of Anesthesia and Intensive Care, Children’s Hospital G Di Cristina, Palermo
- Department of Anesthesia and Intensive Care Ospedale Garibaldi – Nesima, Catania
- Department of Pediatrics Ospedale Policlinico –Universitario G Martino, Messina


```{r, child = "010-descriptives.Rmd"}
```

```{r, child = "020-origin.Rmd", eval=FALSE}
```

```{r, child = "030-ccc.Rmd", eval=FALSE}
```

```{r, child = "040-severity.Rmd", eval=FALSE}
```

```{r, child = "050-los.Rmd", eval=FALSE}
```

# Report download {-}

```{r, echo=FALSE, eval=!params$export, include=!params$export}
downloadLink("report", "Generate report")
```

```{r, context="server", eval=!params$export, include=!params$export}
output$report <- downloadHandler("tipnet-repor.html",
  
  content = function(file) {
    temp_dir <- tempdir()
    file.copy(".", temp_dir,
        overwrite = TRUE,
        recursive = TRUE,
        copy.date = TRUE # this is needed to not invalidate caches
    )
    temp_report <- file.path(temp_dir, "index.Rmd")
    
    read_lines(temp_report) %>% 
      str_replace("^runtime: shiny_prerendered$", "") %>% 
      write_lines(temp_report)
    
    # Set up parameters to pass to Rmd document
    params <- list(
      export = TRUE,
      breaks = input$breaks,
      picu_type = input$picu_type
    )

    # Knit the document, passing in the `params` list, and eval it in a
    # child of the global environment (this isolates the code in the
    # document from the code in this app).
    rmarkdown::render(temp_report, output_file = file,
      params = params,
      envir = new.env(parent = globalenv())
    )
  }
)
```


# References {-}
```{r include=FALSE}
# automatically create a bib database for R packages
knitr::write_bib(c(
  .packages(), 'bookdown', 'knitr', 'rmarkdown'
), 'packages.bib')
```
